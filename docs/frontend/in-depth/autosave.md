# Autosave

Autosave is the way of saving objects in system. Main idea about that is to prevent user from leaving any page without saved data and to make sure that changes he/she made are intentional. The idea is to build on top of:
- [**Scoping data**](#scoping-data)
- [**Handling validation errors**](#handling-validation-errors)
- [**Saving data per context at which user have focus**](#saving-data-per-context-at-which-user-have-focus)
- [**Giving feedback**](#giving-feedback)
- [**Reminding about errors and not saved data**](#reminding-about-errors-and-not-saved-data)

## Scoping data

To give a user proper feedback for a given context data has to be scoped by the unique identifier. Process of generating identifiers is same for every context. Converted Component name to Camel Case `MyComponent => myComponent` is treated as a scope of user feedback.
- Identifiers for tab components have been generated automatically by **`getNestedTabRoutes`** function
- Identifiers for modal components have been generated by **`scopeErrorsMixin`**

## Handling validation errors

Whole validation process is made at backend application. Frontend is only parsing result and assigning it for given scope.

### Parsing validation errors:

- To activate error handling process you need to use **`onErrors`** method from **`feedback`** store. It will execute parsing of validation errors.
- Validating via **`onErrors`** method as an argument taking errors, fieldKeys and scope.
    - **`errors`** - object returned from backend API
```json
    {
        "type": [
            "Type of attribute is required"
        ],
    }
``` 
    - **`fieldKeys`** - optional map of fields which might be replaced at given context
```javascript
{
    type: "myCustomFieldName",
}
```
    - **`scope`** - context scope
    - As a result of once we receive
        - When fieldKeys is not defined result of mapped errors with scope will be 
        ```javascript
        {
            createAttributeModalForm: {
                type: "Type of attribute is required"
            }
        }
        ```
        - When fieldKeys is defined
        ```javascript
        {
            createAttributeModalForm: {
                myCustomFieldName: "Type of attribute is required"
            }
        }
        ```
<div class="Alert Alert--info">
    Flattening supports nested structures.
</div>

## Saving data per context at which user have focus
---

The whole idea is to save data per actual visible context. Each tab / form has its own save button which saves data only at a given context. 

<div class="Alert Alert--warning">
    Currently itâ€™s mixed and will be changed when backend application will adapt required changes.
</div>

## Giving feedback
---

There are 3 levels of displaying user feedback in form of a tab:
- Changes that been made will be acquired by passing **`changeValues`** props to **`HorizontalRoutingTabBar`** component. The passed object should have structure of:

    ```javascript
    {
        productGeneralTab: {
            categories: ["abc68d44-732b-47df-8398-7c8038dc1133"],
            saved: false,
        },
        productTemplateTab: {
            "en_GB|text123/en_GB": "123", // As we can see the field key might be totally customased.
            saved: false,
        }  
    }
    ```

    *Visual result*

    <img src="images/tab_changes.png" alt="User made change at the tab indicator">

- Presenting validation errors will be acquired by passing **`errors`** props to **`HorizontalRoutingTabBar`** component. The passed object should have structure of:

    ```javascript
    {
        createProductModalForm: {
            type: "Type is required",
        }
    }
    ```

    *Visual result*
    
    <img src="images/tab_errors.png" alt="User got errors after validating data at tab indicator">

- Changes that been saved are achieved by invoking **`markChangeValuesAsSaved`** with **`scope`** of component (from the example above it will be `createProductModalForm`) from **`feedback`** store after successful request to BE.

    *Visual result*

    <img src="images/tab_success.png" alt="User saved changes tab indicator">

Additionally, we support editing at Grid:

- Changes that been made and not saved are handled by **`drafts`** props passed to **`Grid`** component. Structure of drafts should be written as:

    ```javascript
    {
        drafts: {
            "5ec31270-e518-4fdf-8e01-e20bfd48ca64/test123:en_GB": "0beb4ddb-2164-4b6e-aff8-0083c4ab4ecc",
        }
    }
    ```
  
    Where:
    - `5ec31270-e518-4fdf-8e01-e20bfd48ca64` is a row id
    - `test123:en_GB` is a column id
    - `0beb4ddb-2164-4b6e-aff8-0083c4ab4ecc` changed value of a cell at given row and column
    
        *Visual result*
        <img src="images/cell_success.png" alt="User made changes at grid">

- Presenting validation errors will be acquired by passing **`errors`** props to **`Grid`** component. The passed object should have structure of:

    ```javascript
    {
        errors: {
            "f2c0f020-9d43-4315-86dc-3911e93502b8/abcd123:en_GB": "This value is too long. It should have 255 characters or less.",
        }
    }
    ```
  
    Where:
    - `f2c0f020-9d43-4315-86dc-3911e93502b8` is a row id
    - `abcd123:en_GB` is a column id
    - `This value is too long. It should have 255 characters or less.` is a validation message about what went wrong
    
        *Visual result*
        <img src="images/cell_error.png" alt="User got errors after validating data at grid cell indicator">

## Reminding about errors and not saved data

When user is about to leave the page without saving the data or any validation errors, application will prompt modal with asking him if he/she is sure about it. The whole logic is done at routing level inside **`beforeRouteLeave`** implemented by **`beforeLeavePageMixin`**. It is checking if data saved at **`feedback`** store has any value for **`changeValues`** or **`errors`**.

<img width="500px" src="images/autosave_modal_feedback.png" alt="Image is presenting modal when user is asked about if he/she want to leave the page without saved data at leaving page">
